
# VectorFloatFMA （向量浮点乘加融合模块）

VectorFloatFMA模块专门执行RISC-V V扩展的向量浮点乘加指令，执行类似 a*b+c 计算，采用了四周期的流水线设计，支持多个FP16、FP32和FP64格式浮点数据的并行计算，包括乘法、乘加、乘减等操作，并处理舍入模式、异常标志及特殊情况，如NaN和无穷大，以实现高性能向量浮点运算。

## 引脚说明

**本次测试过程中，有部分引脚对测试无影响，在本次测试的所有测试用例中都会置为固定值。**

### 通用引脚
|名称|位宽|含义|
|--|--|--|
|clock|1|时钟|
|reset|1|复位|

### 输入引脚
|名称|位宽|含义|
|--|--|--|
|io_fp_a|64|源操作数vs2|
|io_fp_b|64|源操作数vs1|
|io_fp_c|64|源操作数vd|
|io_fire|1|该信号为1时，输入的操作数才有效，开始计算|
|io_round_mode|3|舍入模式，根据IEEE 754标准舍入，0-4有效，其他数值表示无效|
|io_fp_format|2|浮点数据格式，0b01为f16，0b10为f32，0b11为f64，0b00时无效|
|io_op_code|4|操作码，0-8有效，其他无效|
|io_is_vec|1|**本次验证该信号全置1**|
|io_widen_a|64| widen_vs2，**本次验证该信号全置0**|
|io_widen_b|64| widen_vs1，**本次验证该信号全置0**|
|io_frs1|64|浮点寄存器数据，**本次验证该信号全置0**|
|io_is_frs1|1| 加数来自浮点寄存器数据，**本次验证该信号全置0**|
|io_uop_idx|1| widen时选择高/低半部分，**本次验证该信号全置0**|
|io_res_widening|1|widen指令，**本次验证该信号全置0**|
|io_fp_aIsFpCanonicalNAN|1|fp_a输入是否是标准NAN，**本次验证该信号全置0**|
|io_fp_bIsFpCanonicalNAN|1|fp_b输入是否是标准NAN，**本次验证该信号全置0**|
|io_fp_cIsFpCanonicalNAN|1|fp_c输入是否是标准NAN，**本次验证该信号全置0**|

### 输出引脚
|名称|位宽|含义|
|--|--|--|
|io_fp_result|64|计算结果|
|io_fflags|20|异常标志位|

## io_op_code 操作码对应操作

|io_op_code|指令|含义|
| -- | -- | -- |
|0b0000|vf(w)mul|vd=vs2*vs1|
|0b0001|vf(w)macc|vd=+(vs2*vs1)+vd|
|0b0010|vf(w)nmacc|vd=-(vs2*vs1)-vd|
|0b0011|vf(w)msac|vd=+(vs2*vs1)-vd|
|0b0100|vf(w)nmsac|vd=-(vs2*vs1)+vd|
|0b0101|vfmadd|vd=+(vs2*vd)+vs2|
|0b0110|vfnmad|vd=-(vs2*vd)-vs2|
|0b0111|vfmsub|vd=+(vs2*vd)-vs2|
|0b1000|vfnmsub|vd=-(vs2*vd)+vs2|

## io_round_mode 对应舍入模式

|io_round_mode|符号|含义|
|--|--|--|
|0|RNE|最近偶数舍入|
|1|RTZ|向零舍入|
|2|RDN|向下舍入|
|3|RUP|向上舍入|
|4|RMM|最近最大值舍入|

## 主要特性

### 向量多精度并行计算

输入源操作数64位，因此最多支持4个FP16格式、或2个FP32格式、或1个FP64格式浮点数据的并行计算。例如，io_fp_format为0b01时，确定为FP16格式，源操作数io_fp_a的64位均分为4个16位，由高到低分别被定义为fp_a_3、fp_a_2、fp_a_1和fp_a_0，另外2个源操作数io_fp_b和io_fp_c同理。执行乘加操作，即fp_a_3 * fp_b_3 + fp_c_3后得到一个FP16格式的计算结果，4个FP16格式的计算结果组合，形成64位的io_fp_result。

### 流水线设计

采用4级流水线提高吞吐率，步骤主要包括乘法、加法、归一化移位和舍入。

先计算两个浮点数相乘，结果先不舍入，再用这个不舍入的结果和第三个数相加，再进行舍入。

### 输入特殊值

输入操作数含特殊值，如NaN，无穷，零时，结果单独计算，并根据实际输入数的情况从特殊结果和正常结果中选择一个，异常标志位由高到低分别对应无效操作（NV）、除零（DZ）、上溢（OF）、下溢（UF）和不精确（NX）。在本模块中，除了除零标志位外，其他四种都可产生，其中下溢判断为after rounding方式进行检测。

由于支持并行计算，单个计算结果的标志位为5位，在FP16格式下，最多有4个计算结果，因此最终的异常标志信号（fflags）有20位，低有效排列，当结果格式是f16时，20比特全部有效，当结果格式是f32时，低10比特有效，当结果格式是f64时，低5比特有效。

### 验证目标

本次验证主要验证模块的乘加操作、特殊值计算、异常标志判断以及舍入实现等功能性特征。不需要验证波形、接口时序等其他非功能性特征。

## 其他

所有的文档和注释都用中文编写。

## bug分析

在bug分析时，请尽可能详细描述bug表现，且描述功能与spec不一致的地方。
