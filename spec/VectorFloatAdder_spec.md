
# VectorFloatAdder （向量浮点加法模块）

VectorFloatAdder是一个向量整数除法器，支持多种浮点格式（包括半精度、单精度和双精度）的加法和减法运算，并支持精度转换、归约操作和折叠操作等高级功能。

## 引脚说明

**本次测试过程中，有部分引脚对测试无影响，在本次测试的所有测试用例中都会置为固定值。**
### 通用引脚
|名称|位宽|含义|
|--|--|--|
|clock|1|时钟|
|reset|1|复位|

## 输入引脚
|接口名称|位宽|含义|
|--|--|--|
|fire|1位|开始计算|
|fp_a|64位|输入a|
|fp_b|64位|输入b|
|widen_a|64位|**置0**|
|widen_b|64位|**置0**|
|frs1|64位|**置0**|
|is_frs1|1位|**置0**|
|mask|4位|**置0**|
|uop_idx|1位|**置0**|
|is_vec|1位|**置1**|
|round_mode|3位|IEEE754标准的5种舍入模式，对应0～4|
|fp_format|2位|浮点数位宽0～2：f16、f32、f64、无意义|
|res_widening|1位|指示是否为widen指令（结果格式加宽）|
|opb_widening|1位|指示源操作数vs1是否与结果格式相同|
|op_code|5位|操作码，定义具体操作见下方|
|fp_aIsFpCanonicalNAN|1位|**置0**|
|fp_bIsFpCanonicalNAN|1位|**置0**|
|maskForReduction|8位|**置0**|
|is_vfwredosum|1位|**置0**|
|is_fold|3位|**置0**|
|vs2_fold|128位|**置0**|

## 输出引脚
|接口名称|位宽|含义|
|--|--|--|
|fp_result|64位|输出结果|
|fflags|20位|输出标志位，每五位为一个向量的五个标志位，对应依次为：无效操作、被零除、上溢、下溢、不精确，按左边高位右边低位排列|

## opcode对应操作：

|opcode|指令|含义|
|--|--|--|
|0b11111|dummy|空操作或占位符|
|0b00000|fadd|c = a + b|
|0b00001|fsub|c = a - b|
|0b00010|fmin|c = min(a, b)|
|0b00011|fmax|c = max(a, b)|
|0b00100|fmerge|c = (a > b) ? a : b|
|0b00101|fmove|c = b|
|0b00110|fsgnj|c = (a > 0) ? b : -b|
|0b00111|fsgnjn|c = (a > 0) ? -b : b|
|0b01000|fsgnjx|c = (a > 0) ? (b > 0) ? b : -b : (b > 0) ? -b : b|
|0b01001|feq|c = (a == b)|
|0b01010|fne|c = (a != b)|
|0b01011|flt|c = (a < b)|
|0b01100|fle|c = (a <= b)|
|0b01101|fgt|c = (a > b)|
|0b01110|fge|c = (a >= b)|
|0b01111|fclass|向量浮点数值分类​|
|0b10001|fmv_f_s|c = a 标量浮点移动到向量|
|0b10010|fmv_s_f|c = a 向量移动到标量浮点|
|0b11010|fsum_ure|c = a + b 无约束（无序）的向量浮点求和|
|0b10100|fmin_re|c = min(a, b) 有约束（有序）的向量浮点求和|
|0b10101|fmax_re|c = max(a, b) 有约束（有序）的向量浮点求和|
|0b10110|fsum_ore|c = a + b 有约束（有序）的向量浮点求和|
|0b11110|fminm|c = min(a, b) 有约束（有序）的向量浮点求和|
|0b10011|fmaxm|c = max(a, b) 有约束（有序）的向量浮点求和|
|0b11100|fleq|c = (a <= b) 安静版本的浮点小于等于比较|
|0b11011|fltq|c = (a < b) 安静版本的浮点小于比较|


## round_mode 对应舍入模式

|io_round_mode|符号|含义|
|--|--|--|
|0|RNE|最近偶数舍入|
|1|RTZ|向零舍入|
|2|RDN|向下舍入|
|3|RUP|向上舍入|
|4|RMM|最近最大值舍入|


## 主要特性
### 向量多精度并行计算

输入源操作数宽度为64位，支持多种浮点格式的并行计算，包括单一精度（如fp16、fp32、fp64）和混合精度（如widening指令）。具体地，根据fp_format信号（2位控制），64位输入可被划分为不同数量的并行操作：

当fp_format为00（FP16格式）时，io_fp_a的64位均分为4个16位部分（从低到高记为fp_a_0至fp_a_3），io_fp_b同理。并行执行4个FP16加法（如fp_a_0 + fp_b_0），结果组合为64位io_fp_result。
当fp_format为01（FP32格式）时，64位输入均分为2个32位部分，并行执行2个FP32加法。
当fp_format为10（FP64格式）时，整个64位用于1个FP64加法。

此外，支持混合精度计算，如f64 = f64 + f32或f32 = f32 + f16，通过内部快速格式转换算法实现，模块划分支持多格式复用。

### 流水线设计

向量浮点加法器采用两周期流水线设计，以提升吞吐率并满足3GHz高频目标。流水线划分在子模块内部，具体流水线阶段因数据格式而异，包括：
FloatAdderF64Widen模块（处理FP64输出）；FloatAdderF32WidenF16模块（处理FP32/FP16输出）；FloatAdderF16模块（处理FP16输出），流水线划分与FloatAdderF64Widen类似，但时序压力较小。

### 验证目标

验证加减法、规范化与溢出处理、异常标志生成与舍入、浮点分类等相关功能，不需要验证波形、接口时序等其他非功能性特征。

### 输入特殊值处理

输入操作数含特殊值（如NaN、无穷大、零）时，由独立的异常通路处理。异常通路优先判断无效操作、无穷大或NaN情况，并从特殊结果（如NaN或无穷大）与正常计算结果中选择最终输出。标志位fflags宽度为20位，采用低有效排列：

FP16格式时，20位全部有效，对应4个并行结果的标志（每个5位）。
FP32格式时，低10位有效（2个并行结果）。
FP64格式时，低5位有效（1个结果）。

标志类型包括无效操作（NV）、上溢（OF）、下溢（UF）、不精确（NX）。其中，下溢检测采用after rounding方式（符合IEEE 754标准），除零标志（DZ）在加法器中不适用（因加法操作不涉及除法）。

## 其他

所有的文档和注释都用中文编写。

## bug分析

在bug分析时，请尽可能详细描述bug表现，且描述功能与spec不一致的地方。
参考rtl：VectorFloatAdder_RTL/VectorFloatAdder.v

